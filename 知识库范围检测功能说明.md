# 知识库范围检测功能说明

## 功能概述

新增了**智能知识库范围检测**功能，当用户提出的问题超出知识库覆盖范围时，系统会智能识别并给出友好提示，建议用户咨询专业领域的专家。

## 核心特性

### 1. 自动相似度判断
- 基于向量检索的相似度评分（0-1 范围）
- 可配置的阈值判断机制
- 实时检测问题是否在知识库范围内

### 2. 友好用户提示
当问题超出范围时，系统会：
- 明确告知用户问题超出专业领域
- 列出系统的专业知识范围
- 提供建议的解决方案
- 显示相关性评分便于调试

### 3. 无性能损耗
- 基于现有向量检索机制
- 无需额外模型调用
- 响应速度快

## 技术实现

### 配置参数

在 `backend/src/config/settings.py` 中：

```python
# 知识库相似度阈值（0-1），低于此值视为超出范围
knowledge_relevance_threshold: float = 0.60
```

**阈值调整建议**：
- **严格模式** (0.70)：只回答高度相关的问题，准确性高
- **平衡模式** (0.60)：推荐设置，平衡准确性和覆盖面
- **宽松模式** (0.50)：回答更多问题，但可能有误判

### API 响应变化

`ChatResponse` 模型新增字段：

```python
{
    "answer": "回答内容",
    "confidence": "高|中|低",
    "knowledge_sources": [...],
    "llm_model": "qwen-max",
    "has_image": false,
    "out_of_scope": false,           # 新增：是否超出范围
    "relevance_score": 0.85          # 新增：相关性评分
}
```

### 判断逻辑

```
用户提问
    ↓
向量检索知识库
    ↓
获取最高相似度分数
    ↓
是否 >= 阈值？
    ├─ 是 → 正常调用大模型回答
    └─ 否 → 返回超出范围提示
```

## 使用示例

### 示例 1：超出范围的问题

**用户问题**：今天天气怎么样？

**系统响应**：
```json
{
    "answer": "抱歉，您的问题似乎超出了我的专业知识库范围...",
    "confidence": "低",
    "knowledge_sources": [],
    "llm_model": "out_of_scope",
    "out_of_scope": true,
    "relevance_score": 0.12
}
```

### 示例 2：范围内的问题

**用户问题**：NMN对抗衰老有什么作用？

**系统响应**：
```json
{
    "answer": "NMN（烟酰胺单核苷酸）是一种...",
    "confidence": "高",
    "knowledge_sources": ["NMN相关研究资料..."],
    "llm_model": "qwen-max",
    "out_of_scope": false,
    "relevance_score": 0.87
}
```

## 前端集成建议

### 1. UI 显示优化

当 `out_of_scope: true` 时，可以：
- 使用不同的颜色样式（如橙色警告）
- 显示专门的提示图标
- 提供"查看知识库范围"按钮

### 2. 用户引导

```typescript
if (response.out_of_scope) {
    // 显示特殊 UI
    showOutOfScopeWarning(response.answer);
    
    // 提供快速操作
    showSuggestedActions([
        '查看知识库范围',
        '重新提问',
        '联系专家'
    ]);
}
```

### 3. 相关性评分展示

在开发模式下可以显示评分：
```typescript
if (isDevelopment) {
    console.log(`相关性评分: ${response.relevance_score}`);
}
```

## 测试方法

### 运行测试脚本

```bash
cd backend
python test_out_of_scope.py
```

测试脚本会验证：
- ✅ 完全无关的问题（应超出范围）
- ✅ 编程问题（应超出范围）
- ✅ 抗衰老相关问题（应在范围内）
- ✅ 健康饮食问题（应在范围内）

### 手动测试

```bash
curl -X POST "http://localhost:8000/api/v1/chat/" \
  -H "Content-Type: application/json" \
  -d '{
    "question": "今天天气怎么样？",
    "use_knowledge_base": true
  }'
```

## 调优建议

### 1. 监控相关性评分

定期检查日志中的相关性评分分布：
```
INFO - 问题超出知识库范围 - 最高相似度: 0.45, 阈值: 0.60
INFO - 检索到 3 条相关知识, 最高相似度: 0.82
```

### 2. 调整阈值

根据实际使用情况调整 `knowledge_relevance_threshold`：

- 如果**误判太多**（正常问题被拒绝）→ 降低阈值
- 如果**回答质量差**（回答不相关问题）→ 提高阈值

### 3. 扩展知识库

如果发现某类问题经常超出范围但应该支持：
- 添加相关知识条目到知识库
- 重新加载知识库数据

## 日志记录

系统会记录以下信息：

```
# 超出范围
INFO - 问题超出知识库范围 - 最高相似度: 0.45, 阈值: 0.60

# 检索成功
INFO - 检索到 3 条相关知识, 最高相似度: 0.82

# 无检索结果
INFO - 知识库检索无结果，视为超出范围
```

## 环境变量配置

可以通过环境变量覆盖默认阈值：

```bash
# 在 .env 文件中
KNOWLEDGE_RELEVANCE_THRESHOLD=0.65
```

## 注意事项

1. **阈值设置**：建议从 0.60 开始，根据实际效果调整
2. **知识库质量**：确保知识库内容覆盖专业领域
3. **用户体验**：提示语应该友好且提供明确的指引
4. **性能影响**：此功能无额外性能开销
5. **边界情况**：阈值附近的问题可能需要人工审核

## 常见问题

### Q1: 为什么有些相关问题被判定为超出范围？

**A**: 可能原因：
- 阈值设置过高
- 知识库中缺少相关内容
- 问题表述与知识库用词差异大

**解决方案**：
- 适当降低阈值（如从 0.65 降到 0.60）
- 补充相关知识条目
- 优化 embedding 模型

### Q2: 如何临时禁用此功能？

**A**: 将阈值设置为 0：
```python
knowledge_relevance_threshold: float = 0.0
```

### Q3: 相关性评分如何计算？

**A**: 基于 Milvus 的余弦相似度：
- 1.0 = 完全相同
- 0.8-1.0 = 高度相关
- 0.6-0.8 = 中度相关
- < 0.6 = 相关性较低

## 更新日志

### v1.0.0 (2025-10-23)
- ✅ 实现基于相似度阈值的范围检测
- ✅ 添加友好的超出范围提示
- ✅ 新增 `out_of_scope` 和 `relevance_score` 字段
- ✅ 提供测试脚本和完整文档

## 技术支持

如有问题或建议，请：
1. 查看日志文件 `backend/logs/app_*.log`
2. 运行测试脚本验证功能
3. 调整阈值参数重新测试

---

**实现文件清单**：
- `backend/src/config/settings.py` - 配置参数
- `backend/src/models/schemas/chat.py` - 响应模型
- `backend/src/services/rag_service.py` - 核心逻辑
- `backend/test_out_of_scope.py` - 测试脚本

