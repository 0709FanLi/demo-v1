# 🏗️ 系统架构文档

## 1. 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                         用户界面                              │
│                     (React Mobile UI)                        │
└───────────────────────┬─────────────────────────────────────┘
                        │ HTTP/REST API
                        ▼
┌─────────────────────────────────────────────────────────────┐
│                      API网关层                                │
│                    (FastAPI Router)                          │
│  ┌──────────────┐  ┌──────────────┐  ┌─────────────────┐   │
│  │ 知识库管理    │  │  RAG对话     │  │   健康检查      │   │
│  │   /knowledge │  │    /chat     │  │    /health      │   │
│  └──────────────┘  └──────────────┘  └─────────────────┘   │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│                      服务层                                   │
│  ┌─────────────────────────────────────────────────────┐    │
│  │          RAG Service (核心编排)                      │    │
│  └──────────────┬──────────────────┬───────────────────┘    │
│                 │                  │                         │
│     ┌───────────▼──────┐  ┌───────▼──────────┐             │
│     │ Knowledge Service│  │  Aliyun Service  │             │
│     │  (知识库管理)     │  │  (大模型调用)     │             │
│     └───────────┬──────┘  └──────────────────┘             │
└─────────────────┼──────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────┐
│                     数据层                                    │
│  ┌──────────────┐  ┌──────────────┐  ┌─────────────────┐   │
│  │  ChromaDB    │  │ 向量化模型    │  │  阿里云API      │   │
│  │  (向量存储)   │  │ Sentence-T   │  │  通义千问       │   │
│  └──────────────┘  └──────────────┘  └─────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## 2. 核心模块说明

### 2.1 前端层 (Frontend)

**技术栈**:
- React 18 + TypeScript
- Axios (HTTP客户端)
- 纯CSS (响应式设计)

**核心组件**:
- `App.tsx`: 主应用组件，管理对话状态
- `KnowledgePanel.tsx`: 知识库管理面板
- `api.ts`: API服务封装

**数据流**:
```
用户输入 → API请求 → 等待响应 → 更新UI
```

### 2.2 API网关层 (API Router)

**路由模块**:

1. **知识库管理路由** (`knowledge.py`)
   - `POST /api/v1/knowledge/add`: 添加知识
   - `POST /api/v1/knowledge/add-batch`: 批量添加
   - `GET /api/v1/knowledge/search`: 检索知识
   - `DELETE /api/v1/knowledge/delete/{id}`: 删除知识
   - `GET /api/v1/knowledge/count`: 统计信息

2. **对话路由** (`chat.py`)
   - `POST /api/v1/chat/`: RAG对话
   - `POST /api/v1/chat/with-image`: 图文对话
   - `GET /api/v1/chat/simple`: 简单对话

**职责**:
- 请求验证 (Pydantic)
- 错误处理
- 依赖注入
- 响应格式化

### 2.3 服务层 (Services)

#### 2.3.1 KnowledgeService (知识库服务)

**核心功能**:
```python
class KnowledgeService:
    - add_knowledge()        # 添加知识条目
    - search_knowledge()     # 向量检索
    - delete_knowledge()     # 删除条目
    - get_knowledge_count()  # 统计信息
```

**技术实现**:
- ChromaDB: 向量数据库
- Sentence-Transformers: 文本向量化
- 自动文本分块 (chunk_size=500)

**检索流程**:
```
用户查询 → 向量化 → 相似度计算 → Top-K结果 → 返回
```

#### 2.3.2 AliyunService (阿里云服务)

**核心功能**:
```python
class AliyunService:
    - chat()              # 纯文本对话
    - chat_with_image()   # 多模态对话
    - test_connection()   # 连接测试
```

**技术实现**:
- DashScope SDK: 官方Python SDK
- Tenacity: 自动重试机制 (最多3次)
- 异步调用: async/await

**调用流程**:
```
构建消息 → 调用API → 重试(失败) → 解析响应 → 返回
```

#### 2.3.3 RAGService (RAG服务)

**核心功能**:
```python
class RAGService:
    - chat()           # RAG对话主流程
    - chat_simple()    # 简化接口
    - _evaluate_confidence()  # 置信度评估
```

**RAG流程**:
```
1. 接收用户问题
2. 检索知识库 (Top-K=3)
3. 构建增强提示词
4. 调用大模型
5. 评估置信度
6. 返回结构化响应
```

**提示词模板**:
```
【角色定位】
你是专业的智能助手...

【知识库参考】
{检索到的知识}

【用户问题】
{用户输入}

【回答要求】
1. 优先基于知识库
2. 回答简洁明了
3. 不确定时诚实告知
```

### 2.4 数据层

#### 2.4.1 向量数据库 (ChromaDB)

**配置**:
- 持久化路径: `./data/chroma_db`
- 集合名称: `knowledge_base`
- 距离度量: L2 (欧氏距离)

**数据结构**:
```json
{
  "id": "doc_hash_chunk_0",
  "embedding": [0.1, 0.2, ...],  // 384维向量
  "document": "知识文本内容",
  "metadata": {
    "category": "分类",
    "created_at": "时间戳",
    "chunk_count": 1
  }
}
```

#### 2.4.2 向量化模型

**模型**: `paraphrase-multilingual-MiniLM-L12-v2`
- 维度: 384
- 支持: 50+语言
- 速度: ~5ms/句
- 质量: 高

**替代方案**:
- 中文优化: `shibing624/text2vec-base-chinese`
- 英文优化: `all-MiniLM-L6-v2`

#### 2.4.3 阿里云大模型

**模型选择**:

| 模型 | 用途 | 优势 |
|------|------|------|
| qwen-max | 纯文本 | 最强性能 |
| qwen-vl-max | 图文 | 多模态理解 |
| qwen-turbo | 文本 | 高性价比 |

**调用参数**:
- temperature: 0.7 (平衡创造性和准确性)
- max_tokens: 2000 (最大输出长度)

## 3. 数据流图

### 3.1 知识添加流程

```
前端上传
    ↓
API验证
    ↓
文本分块 (500字符)
    ↓
向量化 (Sentence-T)
    ↓
存入ChromaDB
    ↓
返回doc_id
```

### 3.2 RAG对话流程

```
用户提问
    ↓
向量化查询
    ↓
ChromaDB检索 (Top-3)
    ↓
构建Prompt
    ├─ 知识库上下文
    ├─ 用户问题
    └─ 历史对话 (可选)
    ↓
调用通义千问
    ↓
解析响应
    ├─ 评估置信度
    └─ 提取知识来源
    ↓
返回结构化结果
```

### 3.3 图文对话流程

```
用户上传图片
    ↓
前端压缩 (max 1024px)
    ↓
Base64编码
    ↓
后端接收
    ↓
调用qwen-vl-max
    ├─ 图片数据
    └─ 文本问题
    ↓
返回识别结果
```

## 4. 安全与性能

### 4.1 安全措施

- **API Key管理**: 环境变量存储，不硬编码
- **输入验证**: Pydantic模型验证
- **CORS配置**: 限制跨域请求
- **异常处理**: 全局异常捕获
- **日志脱敏**: 不记录敏感信息

### 4.2 性能优化

- **异步处理**: FastAPI全异步
- **连接池**: HTTP客户端复用
- **向量缓存**: ChromaDB内存缓存
- **模型单例**: 服务实例复用
- **自动重试**: Tenacity指数退避

### 4.3 扩展性

**水平扩展**:
- 多进程部署 (Gunicorn)
- 负载均衡 (Nginx)
- 分布式向量库 (Milvus)

**垂直扩展**:
- 更强向量化模型
- 云端向量检索 (阿里云OpenSearch)
- 模型微调

## 5. 监控与日志

### 5.1 日志系统

**工具**: Loguru

**日志级别**:
- DEBUG: 详细调试信息
- INFO: 正常操作日志
- WARNING: 警告信息
- ERROR: 错误异常

**日志轮转**:
- 按日期轮转
- 保留30天
- 自动压缩

### 5.2 监控指标

- API响应时间
- 知识库条目数
- 模型调用次数
- 错误率统计

## 6. 部署架构

### 6.1 开发环境

```
本地开发
├─ Backend: http://localhost:8000
└─ Frontend: http://localhost:3000
```

### 6.2 生产环境

```
Nginx (反向代理)
    ├─ /api → Gunicorn (后端)
    │           └─ Uvicorn Workers
    └─ / → 静态文件 (前端构建)

数据库
    └─ Milvus (分布式向量库)
```

## 7. 技术决策说明

### 7.1 为什么选择ChromaDB？

- ✅ 轻量级，易部署
- ✅ Python原生支持
- ✅ 持久化存储
- ✅ 适合中小规模

### 7.2 为什么选择FastAPI？

- ✅ 高性能异步
- ✅ 自动API文档
- ✅ Pydantic集成
- ✅ 现代Python特性

### 7.3 为什么选择React？

- ✅ 组件化开发
- ✅ 虚拟DOM性能
- ✅ 丰富生态系统
- ✅ TypeScript支持

## 8. 未来优化方向

1. **缓存层**: Redis缓存热点问答
2. **消息队列**: 异步处理知识入库
3. **多模型支持**: 接入更多大模型
4. **知识图谱**: 增强知识关联
5. **用户系统**: 多租户隔离
6. **A/B测试**: 提示词优化
7. **流式响应**: WebSocket实时推送
8. **知识库版本**: Git式版本控制

---

**文档版本**: 1.0  
**更新时间**: 2024-01-01  
**维护者**: 项目团队

