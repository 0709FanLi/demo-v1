# 图片上传时的知识库检索逻辑详解

## 📸 图片上传 + 知识库检索流程

### 当前实现逻辑

**1. 前端调用**
```typescript
// frontend/src/pages/Chat.tsx
if (selectedImage) {
  // 调用图文对话接口，默认 useKnowledge = true
  response = await chatWithImage(
    userMessage.content || '描述这张图片', 
    selectedImage
  );
}
```

**2. API 接口调用**
```typescript
// frontend/src/services/api.ts
export const chatWithImage = async (
  question: string,
  imageFile: File,
  useKnowledge: boolean = true  // 默认启用知识库
)
```

**3. 后端接收请求**
```python
# backend/src/api/routers/chat.py
@router.post('/with-image')
async def chat_with_image(
    question: str = Form(...),
    image: Optional[UploadFile] = File(None),
    use_knowledge_base: bool = Form(True),  # 默认 True
    ...
):
    # 处理图片：压缩 → Base64
    # 构建 ChatRequest
    request = ChatRequest(
        question=question,
        image_base64=image_base64,
        use_knowledge_base=use_knowledge_base,  # 默认启用
    )
    # 调用 RAG 服务
    response = await service.chat(request)
```

**4. RAG 服务处理（关键步骤）**

```python
# backend/src/services/rag_service.py
async def chat(self, request: ChatRequest) -> ChatResponse:
    # 步骤1: 知识库检索（如果有图片，依然会检索！）
    if request.use_knowledge_base:
        # 根据问题文本检索知识库
        search_results = await self.knowledge_service.search_knowledge(
            query=request.question,  # 注意：是用文本问题检索，不是图片
            top_k=settings.knowledge_top_k,
        )
        
        # 检索到的知识会被添加到提示词中
        knowledge_context = '\n\n'.join([
            f'[知识{i+1}] (相似度: {result.score:.2f})\n{result.content}'
            for i, result in enumerate(search_results)
        ])
    
    # 步骤2: 构建完整提示词
    full_prompt = f"""
    你是一位专业的抗衰老领域专家...
    
    {knowledge_context}  # 检索到的知识
    
    用户问题：{request.question}
    """
    
    # 步骤3: 调用多模态模型
    if has_image:  # 检测到图片
        answer = await self.aliyun_service.chat_with_image(
            text=full_prompt,  # 包含知识库内容的提示词
            image_base64=request.image_base64,  # 图片
        )
```

## 🔍 关键问题解答

### Q: 图片会检索知识库吗？

**A: 是的，但检索方式有局限性！**

**当前实现：**
- ✅ **会检索知识库**（如果 `use_knowledge_base=True`）
- ⚠️ **但检索是基于文本问题，不是图片内容**
- ⚠️ **图片只是作为补充信息发送给模型**

**详细流程：**
1. 用户上传图片 + 输入问题（如"这张报告有什么问题？"）
2. 后端用**文本问题**检索知识库（如检索"报告"、"健康"相关的内容）
3. 检索到的知识 + 用户问题文本 + 图片一起发送给多模态模型
4. 模型同时理解：
   - 图片内容（视觉理解）
   - 文本问题
   - 知识库内容（上下文）

### 📊 实际场景示例

**场景 1：上传体检报告图片**
```
用户输入："这张体检报告有什么问题？"
     ↓
检索知识库：用"体检报告"、"问题"等关键词检索
     ↓
检索结果：可能找到相关健康知识
     ↓
发送给模型：
  - 图片：体检报告照片
  - 文本：用户问题 + 知识库内容
     ↓
模型分析：结合图片内容和知识库，给出专业建议
```

**场景 2：上传检查指标图片**
```
用户输入："这些指标正常吗？"
     ↓
检索知识库：用"指标"、"正常"检索
     ↓
发送给模型：图片 + 问题 + 检索到的相关知识
     ↓
模型：识别图片中的指标 + 参考知识库标准 + 给出判断
```

## ⚠️ 当前实现的局限性

**1. 图片内容无法直接检索知识库**
- 只能通过文本问题检索
- 图片内容本身不会用于向量检索

**2. 如果有图片但没有文本问题**
- 前端会发送默认文本："描述这张图片"
- 检索知识库时会用这个默认文本，效果有限

**3. 理想的实现方式（未来改进）**
- 使用图片理解模型提取图片中的文本和关键信息
- 用提取的信息检索知识库
- 或者使用多模态向量检索（如果知识库也包含图片）

## 💡 建议改进方案

**方案 1：OCR + 检索**
```python
# 1. 先用 OCR 提取图片中的文本
extracted_text = ocr_extract(image_base64)

# 2. 用提取的文本检索知识库
search_results = search_knowledge(extracted_text + question)

# 3. 发送给模型
```

**方案 2：多模态检索**
```python
# 如果知识库也包含图片，可以使用多模态向量检索
# 将图片编码为向量，在知识库中检索相似的图片+文本
```

## 📝 总结

**当前逻辑：**
- ✅ 有图片时，**会检索知识库**（基于文本问题）
- ✅ 检索到的知识会添加到提示词中
- ✅ 图片 + 文本 + 知识库内容一起发送给多模态模型
- ⚠️ 检索是基于文本，不是图片内容本身

**效果：**
- 用户问题越具体，检索效果越好
- 建议用户在上传图片时，提供详细的问题描述

