# 知识库管理系统重构方案

## 📋 项目概述

将当前 RAG 对话系统重构为以**知识库管理为核心**的企业级知识库管理系统。

---

## 🎯 重构目标

### 核心目标
1. **知识库管理为核心**：将知识库的增删改查作为主要功能
2. **功能完善**：支持完整的 CRUD 操作（创建、读取、更新、删除）
3. **用户体验优化**：提供直观的管理界面和流畅的操作体验
4. **架构优化**：采用现代化的前后端分离架构
5. **保留 RAG 对话功能**：用户提问时，系统从知识库匹配相关知识，并将匹配结果和问题一起发送给大模型组织回答

### 功能优先级
- **P0（必须实现）**：知识库 CRUD、列表展示、搜索过滤、RAG 对话功能（保留）
- **P1（重要）**：批量操作、分类管理、导入导出
- **P2（可选）**：版本管理、审核流程、权限控制

---

## 🏗️ 架构设计

### 后端架构

```
backend/src/
├── api/
│   ├── routers/
│   │   ├── knowledge.py      # 知识库核心路由（CRUD）
│   │   ├── category.py        # 分类管理路由（新增）
│   │   └── import_export.py   # 导入导出路由（新增）
│   └── dependencies.py       # 依赖注入
├── services/
│   ├── knowledge_service.py   # 知识库核心服务（增强）
│   ├── category_service.py    # 分类管理服务（新增）
│   └── import_export_service.py # 导入导出服务（新增）
├── models/
│   ├── schemas/
│   │   ├── knowledge.py       # 知识库 Schema（扩展）
│   │   ├── category.py        # 分类 Schema（新增）
│   │   └── import_export.py    # 导入导出 Schema（新增）
│   └── tables/               # 数据库表（如需要）
└── utils/
    ├── validators.py          # 数据验证工具（新增）
    └── file_handlers.py       # 文件处理工具（新增）
```

### 前端架构

```
frontend/src/
├── pages/
│   ├── KnowledgeManagement.tsx    # 知识库管理主页面（新增，主要）
│   └── Chat.tsx                   # RAG 对话页面（保留，次要但重要）
├── components/
│   ├── knowledge/
│   │   ├── KnowledgeList.tsx      # 知识列表组件（重构）
│   │   ├── KnowledgeForm.tsx       # 知识表单组件（新增，支持编辑）
│   │   ├── KnowledgeCard.tsx      # 知识卡片组件（新增）
│   │   ├── KnowledgeSearch.tsx    # 搜索组件（新增）
│   │   ├── KnowledgeFilters.tsx   # 筛选组件（新增）
│   │   └── BatchOperations.tsx     # 批量操作组件（新增）
│   ├── category/
│   │   ├── CategoryManager.tsx    # 分类管理组件（新增）
│   │   └── CategorySelector.tsx    # 分类选择器（新增）
│   └── import_export/
│       ├── ImportModal.tsx         # 导入模态框（新增）
│       └── ExportModal.tsx         # 导出模态框（新增）
├── services/
│   ├── api.ts              # API 客户端（扩展）
│   └── knowledgeService.ts # 知识库服务封装（新增）
└── App.tsx                # 主应用（重构：默认显示知识库管理）
```

---

## 📝 功能设计

### 0. RAG 对话功能（保留）⭐

**功能说明**：
- 用户提问时，系统从知识库检索相关知识
- 将匹配到的知识和用户问题一起发送给大模型
- 大模型基于知识库内容组织回答

**后端 API**：
```python
POST /api/v1/chat/rag
- 请求体：ChatRequest
  - question: str
  - use_knowledge_base: bool = True
  - history: List[Dict]
- 响应：ChatResponse
  - answer: str
  - knowledge_sources: List[str]
  - relevance_score: float
  - out_of_scope: bool
```

**前端功能**：
- ✅ 对话界面（保留现有的 Chat 页面）
- ✅ 问题输入
- ✅ AI 回答展示
- ✅ 显示知识来源（可选）
- ✅ 相关性评分显示

**位置**：
- 主页面：知识库管理（默认）
- 导航栏：添加「对话」入口，可切换到 RAG 对话功能

---

### 1. 知识库 CRUD（核心功能）

#### 1.1 创建（Create）
**后端 API**：
```python
POST /api/v1/knowledge/
- 请求体：KnowledgeCreate
  - content: str (必填)
  - category: str (必填)
  - title: str (可选，新增)
  - tags: List[str] (可选，新增)
  - metadata: Dict (可选，新增)
- 响应：KnowledgeResponse
  - success: bool
  - doc_id: str
  - message: str
```

**前端功能**：
- ✅ 表单验证（内容、分类必填）
- ✅ 实时保存草稿
- ✅ 批量添加（多行文本）
- ✅ 富文本编辑器（可选）

#### 1.2 读取（Read）
**后端 API**：
```python
GET /api/v1/knowledge/
- 查询参数：
  - page: int = 1
  - page_size: int = 20
  - category: str (可选)
  - search: str (可选)
  - sort_by: str = 'created_at' (created_at, updated_at, category)
  - order: str = 'desc' (asc, desc)
- 响应：PaginatedKnowledgeResponse
  - items: List[KnowledgeDetail]
  - total: int
  - page: int
  - page_size: int
  - total_pages: int

GET /api/v1/knowledge/{doc_id}
- 响应：KnowledgeDetail
```

**前端功能**：
- ✅ 列表展示（卡片式）
- ✅ 分页导航
- ✅ 详情查看（模态框）
- ✅ 搜索高亮
- ✅ 排序选择

#### 1.3 更新（Update）⭐ 新增
**后端 API**：
```python
PUT /api/v1/knowledge/{doc_id}
- 请求体：KnowledgeUpdate
  - content: str (可选)
  - category: str (可选)
  - title: str (可选)
  - tags: List[str] (可选)
- 响应：KnowledgeResponse

PATCH /api/v1/knowledge/{doc_id}
- 部分更新（同上）
```

**前端功能**：
- ✅ 编辑表单（复用创建表单）
- ✅ 版本对比（可选）
- ✅ 更新历史（可选）

#### 1.4 删除（Delete）
**后端 API**：
```python
DELETE /api/v1/knowledge/{doc_id}
- 响应：KnowledgeResponse

DELETE /api/v1/knowledge/batch
- 请求体：{ doc_ids: List[str] }
- 批量删除
```

**前端功能**：
- ✅ 单条删除（确认对话框）
- ✅ 批量删除（多选）
- ✅ 软删除（可选，保留记录）

---

### 2. 搜索与筛选

**后端 API**：
```python
GET /api/v1/knowledge/search
- 查询参数：
  - q: str (搜索关键词)
  - category: str (分类筛选)
  - tags: List[str] (标签筛选)
  - date_from: str (日期范围)
  - date_to: str
  - top_k: int = 10 (向量相似度搜索)
- 响应：List[KnowledgeSearchResult]
```

**前端功能**：
- ✅ 全文搜索（实时）
- ✅ 分类筛选（下拉）
- ✅ 标签筛选（多选）
- ✅ 日期范围筛选
- ✅ 向量相似度搜索（高级搜索）

---

### 3. 分类管理

**后端 API**：
```python
GET /api/v1/categories/
- 响应：List[Category]

POST /api/v1/categories/
- 创建分类

PUT /api/v1/categories/{category_id}
- 更新分类

DELETE /api/v1/categories/{category_id}
- 删除分类

GET /api/v1/categories/stats
- 统计各分类知识数量
```

**前端功能**：
- ✅ 分类列表（侧边栏）
- ✅ 分类创建/编辑
- ✅ 分类统计（知识数量）
- ✅ 分类颜色标记

---

### 4. 批量操作

**后端 API**：
```python
POST /api/v1/knowledge/batch
- 批量添加：{ items: List[KnowledgeCreate] }

DELETE /api/v1/knowledge/batch
- 批量删除：{ doc_ids: List[str] }

PUT /api/v1/knowledge/batch
- 批量更新：{ doc_ids: List[str], updates: Dict }
```

**前端功能**：
- ✅ 多选（复选框）
- ✅ 全选/反选
- ✅ 批量删除
- ✅ 批量修改分类
- ✅ 批量添加标签

---

### 5. 导入导出

#### 5.1 导入功能

**支持的格式**：

| 格式 | 扩展名 | 说明 | 适用场景 |
|------|-------|------|---------|
| **JSON** | `.json` | JSON 数组格式 | 结构化数据，批量导入 |
| **CSV** | `.csv` | 逗号分隔值 | 简单表格数据 |
| **Excel** | `.xlsx`, `.xls` | Excel 表格 | 复杂表格，多工作表 |
| **TXT** | `.txt` | 纯文本格式 | 简单文本，每行一条 |
| **Markdown** | `.md` | Markdown 文档 | 结构化文档，支持标题和内容 |

**JSON 格式示例**：
```json
[
  {
    "content": "知识内容1",
    "category": "分类1",
    "title": "标题1（可选）",
    "tags": ["标签1", "标签2"]
  },
  {
    "content": "知识内容2",
    "category": "分类2"
  }
]
```

**CSV 格式示例**：
```csv
content,category,title,tags
"知识内容1","分类1","标题1","标签1,标签2"
"知识内容2","分类2","",""
```

**Excel 格式要求**：
- 第一行为表头（content, category, title, tags）
- `content` 和 `category` 为必填列
- `title` 和 `tags` 为可选列
- `tags` 列：多个标签用逗号分隔

**TXT 格式示例**：
```
每条知识占一行，自动归类到"未分类"
或使用分隔符：分类|内容
```

**Markdown 格式示例**：
```markdown
# 分类名称

## 知识标题1（可选）
知识内容1

## 知识标题2（可选）
知识内容2
```

**后端 API**：
```python
POST /api/v1/knowledge/import
- Content-Type: multipart/form-data
- 请求参数：
  - file: File (必填，支持 .json, .csv, .xlsx, .xls, .txt, .md)
  - format: str (可选，auto/json/csv/excel/txt/markdown)
  - default_category: str (可选，默认分类，用于 TXT 格式)
- 响应：ImportResult
  - success_count: int
  - failed_count: int
  - total_count: int
  - errors: List[Dict[str, str]]  # [{row: int, error: str}]
  - preview: List[Dict] (前5条预览)
```

**前端功能**：
- ✅ 文件上传（拖拽支持）
- ✅ 格式自动识别
- ✅ 导入预览（显示前5条）
- ✅ 字段映射（CSV/Excel）
- ✅ 错误提示（行号+错误信息）
- ✅ 批量导入进度条
- ✅ 导入结果统计

#### 5.2 导出功能

**支持的格式**：

| 格式 | 扩展名 | 说明 | 适用场景 |
|------|-------|------|---------|
| **JSON** | `.json` | JSON 数组 | 数据备份、程序处理 |
| **CSV** | `.csv` | 逗号分隔值 | Excel 打开、简单分析 |
| **Excel** | `.xlsx` | Excel 表格 | 复杂导出、多工作表 |

**后端 API**：
```python
GET /api/v1/knowledge/export
- 查询参数：
  - format: str (json, csv, excel) 默认: json
  - category: str (可选，筛选分类)
  - tags: List[str] (可选，筛选标签)
  - date_from: str (可选，开始日期)
  - date_to: str (可选，结束日期)
- 响应：文件下载
  - Content-Type: application/json / text/csv / application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
  - Content-Disposition: attachment; filename="knowledge_export_YYYYMMDD_HHMMSS.{ext}"
```

**前端功能**：
- ✅ 格式选择（JSON/CSV/Excel）
- ✅ 筛选条件选择
- ✅ 导出进度显示
- ✅ 文件下载（浏览器自动下载）

---

## 🎨 UI/UX 设计

### 主页面布局

```
┌─────────────────────────────────────────────────┐
│  Header                                         │
│  📚 知识库管理系统    [搜索框] [+ 添加] [导出]   │
│  [导航] [知识库管理] [对话]                     │
├──────────┬──────────────────────────────────────┤
│          │                                      │
│  侧边栏  │         主内容区                      │
│          │                                      │
│  📁 分类 │  ┌────────┐ ┌────────┐ ┌────────┐ │
│  • 全部  │  │知识卡片│ │知识卡片│ │知识卡片│ │
│  • 分类1 │  │        │ │        │ │        │ │
│  • 分类2 │  └────────┘ └────────┘ └────────┘ │
│  • 分类3 │                                      │
│          │  [分页导航]                          │
│  🔍 筛选 │                                      │
│  • 标签  │                                      │
│  • 日期  │                                      │
│          │                                      │
└──────────┴──────────────────────────────────────┘
```

### 知识卡片设计

```
┌─────────────────────────────────────┐
│ [✓] 标题（可点击查看详情）            │
│ 🏷️ 分类  📅 日期  🔖 标签1 标签2    │
│ ─────────────────────────────────── │
│ 内容预览（最多150字）...              │
│ [查看完整内容 ▼] [编辑] [删除]       │
└─────────────────────────────────────┘
```

---

## 🔧 技术实现细节

### 后端实现

#### 1. Schema 扩展

```python
# models/schemas/knowledge.py

class KnowledgeCreate(BaseModel):
    content: str = Field(..., min_length=10, max_length=10000)
    category: str = Field(..., min_length=1, max_length=50)
    title: Optional[str] = Field(None, max_length=200)
    tags: Optional[List[str]] = Field(default_factory=list)
    metadata: Optional[Dict[str, Any]] = Field(default_factory=dict)

class KnowledgeUpdate(BaseModel):
    content: Optional[str] = Field(None, min_length=10, max_length=10000)
    category: Optional[str] = Field(None, min_length=1, max_length=50)
    title: Optional[str] = Field(None, max_length=200)
    tags: Optional[List[str]] = None
    metadata: Optional[Dict[str, Any]] = None

class KnowledgeDetail(KnowledgeSearchResult):
    chunks: List[Dict[str, Any]]  # 显示所有分块
    created_at: datetime
    updated_at: datetime

class PaginatedKnowledgeResponse(BaseModel):
    items: List[KnowledgeDetail]
    total: int
    page: int
    page_size: int
    total_pages: int
```

#### 2. 更新服务方法

```python
# services/knowledge_service.py

async def update_knowledge(
    self,
    doc_id: str,
    update_data: KnowledgeUpdate
) -> bool:
    """更新知识条目."""
    # 1. 检索现有数据
    # 2. 更新字段
    # 3. 重新向量化（如果内容变更）
    # 4. 更新 Milvus
    # 5. 返回结果

async def get_knowledge_by_id(
    self,
    doc_id: str
) -> Optional[KnowledgeDetail]:
    """根据ID获取知识详情."""
    
async def search_knowledge_advanced(
    self,
    query: Optional[str] = None,
    category: Optional[str] = None,
    tags: Optional[List[str]] = None,
    date_from: Optional[datetime] = None,
    date_to: Optional[datetime] = None,
    page: int = 1,
    page_size: int = 20,
    sort_by: str = 'created_at',
    order: str = 'desc'
) -> PaginatedKnowledgeResponse:
    """高级搜索."""
```

### 前端实现

#### 1. 状态管理

```typescript
// 使用 React Context 或 Zustand（推荐）
interface KnowledgeState {
  knowledgeList: KnowledgeItem[];
  selectedIds: string[];
  filters: KnowledgeFilters;
  pagination: Pagination;
  loading: boolean;
}
```

#### 2. 组件拆分

- **KnowledgeList**: 列表容器（管理状态、分页）
- **KnowledgeCard**: 单个知识卡片（展示、操作）
- **KnowledgeForm**: 表单组件（创建/编辑）
- **KnowledgeSearch**: 搜索组件（实时搜索）
- **KnowledgeFilters**: 筛选组件（分类、标签、日期）

---

## 📊 数据库设计

### Milvus 集合结构（保持现有）

```python
fields = [
    FieldSchema(name="id", dtype=DataType.VARCHAR, max_length=255, is_primary=True),
    FieldSchema(name="doc_id", dtype=DataType.VARCHAR, max_length=255),
    FieldSchema(name="chunk_index", dtype=DataType.INT64),
    FieldSchema(name="content", dtype=DataType.VARCHAR, max_length=50000),
    FieldSchema(name="category", dtype=DataType.VARCHAR, max_length=100),
    FieldSchema(name="metadata", dtype=DataType.JSON),
    FieldSchema(name="vector", dtype=DataType.FLOAT_VECTOR, dim=1024),
]
```

### 可选：关系数据库（PostgreSQL/MySQL）

如果需要复杂查询和关联，可添加关系数据库：

```sql
CREATE TABLE knowledge_base (
    id SERIAL PRIMARY KEY,
    doc_id VARCHAR(255) UNIQUE NOT NULL,
    title VARCHAR(200),
    content TEXT NOT NULL,
    category VARCHAR(50) NOT NULL,
    tags JSONB,
    metadata JSONB,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE categories (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) UNIQUE NOT NULL,
    color VARCHAR(7),
    description TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

## 🚀 实施计划

### Phase 0: RAG 对话功能确认（已完成）✅

- [x] 确认保留现有的 RAG 对话功能
- [x] 确保对话 API 正常工作
- [x] 在重构方案中明确保留该功能

### Phase 1: 核心功能（1-2周）

1. **后端 API 扩展**
   - [ ] 实现 `update_knowledge` 方法
   - [ ] 实现 `get_knowledge_by_id` 方法
   - [ ] 扩展分页和搜索 API
   - [ ] 添加批量操作 API
   - [x] 确认 RAG 对话 API 正常工作

2. **前端主页面重构**
   - [ ] 创建 `KnowledgeManagement.tsx` 主页面（默认显示）
   - [ ] 创建导航栏（知识库管理 / 对话切换）
   - [ ] 实现知识列表组件
   - [ ] 实现知识卡片组件
   - [ ] 实现搜索和筛选组件
   - [ ] 将现有 `Chat.tsx` 保留为对话页面

3. **编辑功能**
   - [ ] 实现编辑表单
   - [ ] 实现更新 API 调用
   - [ ] 添加更新成功提示

### Phase 2: 增强功能（1周）

1. **分类管理**
   - [ ] 后端分类 API
   - [ ] 前端分类管理组件
   - [ ] 分类统计展示

2. **批量操作**
   - [ ] 多选功能
   - [ ] 批量删除
   - [ ] 批量更新分类

3. **搜索优化**
   - [ ] 高级搜索UI
   - [ ] 搜索历史（可选）
   - [ ] 搜索建议（可选）

### Phase 3: 导入导出（1周）

1. **导入功能**
   - [ ] 文件上传组件
   - [ ] JSON/CSV 解析
   - [ ] 导入预览和错误处理

2. **导出功能**
   - [ ] 导出格式选择
   - [ ] 数据格式化
   - [ ] 文件下载

### Phase 4: 优化与测试（1周）

1. **性能优化**
   - [ ] 列表虚拟滚动（大数据量）
   - [ ] 搜索防抖
   - [ ] 缓存策略

2. **测试**
   - [ ] 单元测试
   - [ ] 集成测试
   - [ ] E2E 测试

---

## 📦 依赖更新

### 后端

```txt
# requirements.txt 新增
pydantic[email]>=2.0.0  # 已存在，确保版本
openpyxl>=3.1.0         # Excel 导入导出
pandas>=2.0.0           # 数据处理（CSV/Excel）
markdown>=3.4.0         # Markdown 解析（可选）
```

### 前端

```json
// package.json 新增
{
  "dependencies": {
    "react-virtualized": "^9.22.0",  // 虚拟滚动（可选）
    "react-select": "^5.8.0",         // 下拉选择
    "date-fns": "^2.30.0",            // 日期处理
    "file-saver": "^2.0.5"             // 文件下载
  }
}
```

---

## ✅ 验收标准

### 功能验收
- [ ] 可以创建、查看、编辑、删除知识
- [ ] 支持分页浏览
- [ ] 支持搜索和筛选
- [ ] 支持批量操作
- [ ] 支持导入导出

### 性能验收
- [ ] 列表加载时间 < 1s（100条数据）
- [ ] 搜索响应时间 < 500ms
- [ ] 支持 1000+ 条知识无卡顿

### 用户体验验收
- [ ] 界面美观、操作流畅
- [ ] 错误提示友好
- [ ] 支持快捷键操作
- [ ] 移动端适配（可选）

---

## 🎯 功能保留说明

### RAG 对话功能（必须保留）

**功能流程**：
```
用户提问 
  ↓
系统从知识库检索相关知识（向量相似度匹配）
  ↓
获取 Top-K 相关知识条目
  ↓
构建 Prompt：问题 + 相关知识
  ↓
发送给大模型（通义千问）
  ↓
返回组织好的回答
```

**实现位置**：
- **后端**：`backend/src/api/routers/chat.py` - 保持不变
- **后端**：`backend/src/services/rag_service.py` - 保持不变
- **前端**：`frontend/src/pages/Chat.tsx` - 保留并优化
- **路由**：添加导航切换，默认显示知识库管理，可通过导航切换到对话

**优化建议**：
- 在对话页面显示知识来源（可选）
- 显示相关性评分
- 支持清除对话历史

---

## 🎯 下一步行动

1. **确认方案**：与您确认重构方案是否符合需求（已更新：明确保留 RAG 对话功能）
2. **开始实施**：按 Phase 1 开始实现核心功能
3. **迭代开发**：每完成一个功能模块，及时测试和反馈

---

**重构方案已更新：明确保留 RAG 对话功能！我们可以开始实施了！** 🚀

