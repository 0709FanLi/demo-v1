# ğŸš€ æŠ—è¡°è€ä¸“å®¶å’¨è¯¢ç³»ç»Ÿ - éƒ¨ç½²æŒ‡å—

## ğŸ“‹ ç›®å½•

1. [éƒ¨ç½²æ¦‚è¿°](#éƒ¨ç½²æ¦‚è¿°)
2. [æœåŠ¡å™¨è¦æ±‚](#æœåŠ¡å™¨è¦æ±‚)
3. [å¿«é€Ÿéƒ¨ç½²](#å¿«é€Ÿéƒ¨ç½²)
4. [æ‰‹åŠ¨éƒ¨ç½²](#æ‰‹åŠ¨éƒ¨ç½²)
5. [æ—¥å¸¸è¿ç»´](#æ—¥å¸¸è¿ç»´)
6. [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)
7. [å¤‡ä»½æ¢å¤](#å¤‡ä»½æ¢å¤)

---

## éƒ¨ç½²æ¦‚è¿°

### æ¶æ„è¯´æ˜

æœ¬é¡¹ç›®é‡‡ç”¨ **Docker Compose** éƒ¨ç½²æ–¹æ¡ˆï¼ŒåŒ…å«ä»¥ä¸‹æœåŠ¡ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Nginx (80)                  â”‚
â”‚    åå‘ä»£ç† + è´Ÿè½½å‡è¡¡               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â”‚             â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚Frontendâ”‚   â”‚Backend â”‚
â”‚ (3000) â”‚   â”‚ (8001) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                 â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
          â”‚   Milvus    â”‚
          â”‚  (19530)    â”‚
          â”‚   + etcd    â”‚
          â”‚   + minio   â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æœåŠ¡ä¿¡æ¯

| æœåŠ¡ | ç«¯å£ | è¯´æ˜ |
|------|------|------|
| Nginx | 80 | Web å…¥å£ |
| Frontend | 3000 | React åº”ç”¨ |
| Backend | 8001 | FastAPI åº”ç”¨ |
| Milvus | 19530 | å‘é‡æ•°æ®åº“ |

---

## æœåŠ¡å™¨è¦æ±‚

### ç¡¬ä»¶é…ç½®

- **CPU**: 2 æ ¸å¿ƒä»¥ä¸Š
- **å†…å­˜**: 4GB ä»¥ä¸Šï¼ˆæ¨è 8GBï¼‰
- **ç¡¬ç›˜**: 20GB ä»¥ä¸Šå¯ç”¨ç©ºé—´
- **ç½‘ç»œ**: å…¬ç½‘ IPï¼Œå¼€æ”¾ 80ã€443ã€22 ç«¯å£

### è½¯ä»¶è¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: Ubuntu 20.04+ / CentOS 7+
- **Docker**: 20.10+
- **Docker Compose**: 2.0+

**æœ¬é¡¹ç›®æœåŠ¡å™¨**ï¼š
- IP: 106.14.204.36
- ç”¨æˆ·: root
- å·²å¼€æ”¾ç«¯å£: 22, 80, 443

---

## å¿«é€Ÿéƒ¨ç½²

### æ–¹å¼ä¸€ï¼šä¸€é”®éƒ¨ç½²ï¼ˆæ¨èï¼‰â­

åœ¨**æœ¬åœ°**æ‰§è¡Œï¼š

```bash
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd /Users/liguangyuan/Documents/GitHub/demo-v1

# 2. æ‰§è¡Œéƒ¨ç½²è„šæœ¬
bash deploy.sh
```

**è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆ**ï¼š
- âœ… æ£€æŸ¥ç¯å¢ƒ
- âœ… è¿æ¥æœåŠ¡å™¨
- âœ… åŒæ­¥ä»£ç 
- âœ… å®‰è£… Docker
- âœ… æ„å»ºé•œåƒ
- âœ… å¯åŠ¨æœåŠ¡
- âœ… é…ç½®é˜²ç«å¢™
- âœ… å¥åº·æ£€æŸ¥

**é¢„è®¡æ—¶é—´**: 10-15 åˆ†é’Ÿ

---

### æ–¹å¼äºŒï¼šåˆ†æ­¥éƒ¨ç½²

#### æ­¥éª¤1ï¼šåŒæ­¥ä»£ç åˆ°æœåŠ¡å™¨

```bash
# ä½¿ç”¨ rsync åŒæ­¥
rsync -avz --delete \
  --exclude 'node_modules/' \
  --exclude 'venv/' \
  --exclude 'volumes/' \
  --exclude '.git/' \
  ./ root@106.14.204.36:/root/anti-aging-system/
```

#### æ­¥éª¤2ï¼šSSH è¿æ¥æœåŠ¡å™¨

```bash
ssh root@106.14.204.36
# å¯†ç : Yuan0730zhen.
```

#### æ­¥éª¤3ï¼šå®‰è£… Docker

```bash
# å®‰è£… Docker
curl -fsSL https://get.docker.com | sh
systemctl start docker
systemctl enable docker

# å®‰è£… Docker Compose
curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose

# éªŒè¯å®‰è£…
docker --version
docker-compose --version
```

#### æ­¥éª¤4ï¼šé…ç½®ç¯å¢ƒå˜é‡

```bash
cd /root/anti-aging-system

# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cp env.production.template .env

# ç¼–è¾‘ç¯å¢ƒå˜é‡ï¼ˆå¦‚éœ€ä¿®æ”¹ï¼‰
vim .env
```

#### æ­¥éª¤5ï¼šåˆ›å»ºå¿…è¦ç›®å½•

```bash
mkdir -p logs/backend logs/nginx
mkdir -p volumes/etcd volumes/minio volumes/milvus
mkdir -p backend/data
```

#### æ­¥éª¤6ï¼šå¯åŠ¨æœåŠ¡

```bash
# æ„å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose.prod.yml up -d --build

# æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f
```

#### æ­¥éª¤7ï¼šéªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps

# æ£€æŸ¥å¥åº·çŠ¶æ€
curl http://localhost/api/health
curl http://localhost
```

---

## æ—¥å¸¸è¿ç»´

### æŸ¥çœ‹æœåŠ¡çŠ¶æ€

```bash
cd /root/anti-aging-system

# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps

# æŸ¥çœ‹èµ„æºä½¿ç”¨
docker stats
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f backend
docker-compose -f docker-compose.prod.yml logs -f frontend
docker-compose -f docker-compose.prod.yml logs -f milvus-standalone

# æŸ¥çœ‹æœ€è¿‘100è¡Œæ—¥å¿—
docker-compose -f docker-compose.prod.yml logs --tail=100 backend
```

### é‡å¯æœåŠ¡

```bash
# é‡å¯æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose.prod.yml restart

# é‡å¯ç‰¹å®šæœåŠ¡
docker-compose -f docker-compose.prod.yml restart backend
docker-compose -f docker-compose.prod.yml restart frontend
```

### åœæ­¢æœåŠ¡

```bash
# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose.prod.yml down

# åœæ­¢å¹¶åˆ é™¤æ‰€æœ‰æ•°æ®ï¼ˆå±é™©ï¼ï¼‰
docker-compose -f docker-compose.prod.yml down -v
```

### æ›´æ–°åº”ç”¨

```bash
# æ–¹æ³•1ï¼šæœ¬åœ°æ‰§è¡Œéƒ¨ç½²è„šæœ¬ï¼ˆæ¨èï¼‰
bash deploy.sh

# æ–¹æ³•2ï¼šæœåŠ¡å™¨æ‰‹åŠ¨æ›´æ–°
cd /root/anti-aging-system
git pull  # å¦‚æœä½¿ç”¨ git
docker-compose -f docker-compose.prod.yml up -d --build
```

### æ¸…ç† Docker èµ„æº

```bash
# æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
docker image prune -a

# æ¸…ç†æœªä½¿ç”¨çš„å®¹å™¨
docker container prune

# æ¸…ç†æœªä½¿ç”¨çš„å·
docker volume prune

# å…¨é¢æ¸…ç†ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
docker system prune -a
```

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šæœåŠ¡æ— æ³•å¯åŠ¨

**ç—‡çŠ¶**ï¼šå®¹å™¨å¯åŠ¨åç«‹å³é€€å‡º

**æ’æŸ¥æ­¥éª¤**ï¼š

```bash
# 1. æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps

# 2. æŸ¥çœ‹é”™è¯¯æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs backend

# 3. æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep -E ':(80|3000|8001|19530)'

# 4. æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h

# 5. æ£€æŸ¥å†…å­˜
free -h
```

**å¸¸è§åŸå› **ï¼š
- ç«¯å£è¢«å ç”¨
- ç¯å¢ƒå˜é‡æœªé…ç½®
- ç£ç›˜ç©ºé—´ä¸è¶³
- å†…å­˜ä¸è¶³

---

### é—®é¢˜2ï¼šå‰ç«¯æ— æ³•è®¿é—®åç«¯

**ç—‡çŠ¶**ï¼šå‰ç«¯æ˜¾ç¤º Network Error

**æ’æŸ¥æ­¥éª¤**ï¼š

```bash
# 1. æ£€æŸ¥åç«¯å¥åº·çŠ¶æ€
curl http://localhost:8001/health

# 2. æ£€æŸ¥ Nginx é…ç½®
docker-compose -f docker-compose.prod.yml logs nginx

# 3. æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
docker-compose -f docker-compose.prod.yml exec frontend ping backend

# 4. æ£€æŸ¥ CORS é…ç½®
# æŸ¥çœ‹åç«¯æ—¥å¿—ä¸­çš„ CORS ç›¸å…³ä¿¡æ¯
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç¡®è®¤åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ
- æ£€æŸ¥ Nginx åå‘ä»£ç†é…ç½®
- ç¡®è®¤ API URL é…ç½®æ­£ç¡®

---

### é—®é¢˜3ï¼šMilvus è¿æ¥å¤±è´¥

**ç—‡çŠ¶**ï¼šåç«¯æ—¥å¿—æ˜¾ç¤º Milvus è¿æ¥é”™è¯¯

**æ’æŸ¥æ­¥éª¤**ï¼š

```bash
# 1. æ£€æŸ¥ Milvus çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps milvus-standalone

# 2. æ£€æŸ¥ Milvus å¥åº·çŠ¶æ€
curl http://localhost:9091/healthz

# 3. æŸ¥çœ‹ Milvus æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs milvus-standalone

# 4. æ£€æŸ¥ etcd å’Œ minio
docker-compose -f docker-compose.prod.yml ps etcd minio
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç­‰å¾… Milvus å®Œå…¨å¯åŠ¨ï¼ˆçº¦30ç§’ï¼‰
- æ£€æŸ¥ volumes ç›®å½•æƒé™
- é‡å¯ Milvus æœåŠ¡

---

### é—®é¢˜4ï¼šå†…å­˜ä¸è¶³

**ç—‡çŠ¶**ï¼šæœåŠ¡é¢‘ç¹é‡å¯ï¼Œç³»ç»Ÿå¡é¡¿

**æ’æŸ¥æ­¥éª¤**ï¼š

```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h

# æŸ¥çœ‹å„å®¹å™¨å†…å­˜ä½¿ç”¨
docker stats --no-stream
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **ä¼˜åŒ– Docker èµ„æºé™åˆ¶**ï¼š

ç¼–è¾‘ `docker-compose.prod.yml`ï¼Œæ·»åŠ èµ„æºé™åˆ¶ï¼š

```yaml
services:
  backend:
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
```

2. **å¢åŠ  Swap ç©ºé—´**ï¼š

```bash
# åˆ›å»º 2GB Swap
dd if=/dev/zero of=/swapfile bs=1M count=2048
chmod 600 /swapfile
mkswap /swapfile
swapon /swapfile

# æ°¸ä¹…ç”Ÿæ•ˆ
echo '/swapfile none swap sw 0 0' >> /etc/fstab
```

---

## å¤‡ä»½æ¢å¤

### è‡ªåŠ¨å¤‡ä»½

æœåŠ¡å™¨ä¸Šå·²é…ç½®å¤‡ä»½è„šæœ¬ï¼š

```bash
# æ‰§è¡Œå¤‡ä»½
cd /root/anti-aging-system
bash backup.sh

# å¤‡ä»½ä½ç½®
ls -lh /root/backups/
```

**å¤‡ä»½å†…å®¹**ï¼š
- Milvus æ•°æ®ï¼ˆvolumes/milvusï¼‰
- etcd æ•°æ®ï¼ˆvolumes/etcdï¼‰
- MinIO æ•°æ®ï¼ˆvolumes/minioï¼‰
- åç«¯æ•°æ®ï¼ˆbackend/dataï¼‰
- ç¯å¢ƒé…ç½®ï¼ˆ.envï¼‰

**è‡ªåŠ¨åŒ–å¤‡ä»½**ï¼ˆå¯é€‰ï¼‰ï¼š

```bash
# æ·»åŠ å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½ï¼‰
crontab -e

# æ·»åŠ ä»¥ä¸‹è¡Œ
0 2 * * * cd /root/anti-aging-system && bash backup.sh >> /root/backups/backup.log 2>&1
```

---

### æ¢å¤æ•°æ®

```bash
# 1. åœæ­¢æœåŠ¡
docker-compose -f docker-compose.prod.yml down

# 2. è§£å‹å¤‡ä»½
cd /root/backups
tar -xzf anti-aging-backup-YYYYMMDD_HHMMSS.tar.gz

# 3. æ¢å¤æ•°æ®
cd anti-aging-backup-YYYYMMDD_HHMMSS
cp -r milvus /root/anti-aging-system/volumes/
cp -r etcd /root/anti-aging-system/volumes/
cp -r minio /root/anti-aging-system/volumes/
cp -r data /root/anti-aging-system/backend/

# 4. é‡å¯æœåŠ¡
cd /root/anti-aging-system
docker-compose -f docker-compose.prod.yml up -d
```

---

## å®‰å…¨å»ºè®®

### 1. æ›´æ”¹é»˜è®¤å¯†ç 

```bash
# æ›´æ”¹ root å¯†ç 
passwd root

# æ›´æ”¹æœåŠ¡å™¨ SSH å¯†ç åï¼Œæ›´æ–°æœ¬åœ° deploy.sh ä¸­çš„å¯†ç 
```

### 2. é…ç½®é˜²ç«å¢™

```bash
# å®‰è£… ufw
apt-get install ufw

# é…ç½®è§„åˆ™
ufw allow 22/tcp   # SSH
ufw allow 80/tcp   # HTTP
ufw allow 443/tcp  # HTTPSï¼ˆå¦‚éœ€ï¼‰

# å¯ç”¨é˜²ç«å¢™
ufw enable

# æŸ¥çœ‹çŠ¶æ€
ufw status
```

### 3. é…ç½® HTTPSï¼ˆå¯é€‰ï¼‰

```bash
# å®‰è£… Certbot
apt-get install certbot

# å¦‚æœæœ‰åŸŸåï¼Œç”³è¯·è¯ä¹¦
certbot certonly --standalone -d your-domain.com

# æ›´æ–° Nginx é…ç½®æ”¯æŒ HTTPS
```

### 4. é™åˆ¶ API è®¿é—®ï¼ˆå¯é€‰ï¼‰

å¯ä»¥åœ¨ Nginx é…ç½®ä¸­æ·»åŠ  IP ç™½åå•ï¼š

```nginx
# ä»…å…è®¸ç‰¹å®š IP è®¿é—® API
location /api/ {
    allow 1.2.3.4;  # å…è®¸çš„ IP
    deny all;       # æ‹’ç»å…¶ä»–
    proxy_pass http://backend_api/api/;
}
```

---

## ç›‘æ§å’Œå‘Šè­¦

### ç®€å•ç›‘æ§è„šæœ¬

åˆ›å»º `/root/monitor.sh`ï¼š

```bash
#!/bin/bash

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
check_service() {
    if curl -s http://localhost/api/health | grep -q "OK"; then
        echo "âœ“ æœåŠ¡æ­£å¸¸"
    else
        echo "âœ— æœåŠ¡å¼‚å¸¸"
        # å¯ä»¥å‘é€å‘Šè­¦é‚®ä»¶æˆ–é’‰é’‰é€šçŸ¥
    fi
}

# æ£€æŸ¥ç£ç›˜ç©ºé—´
check_disk() {
    USAGE=$(df -h / | tail -1 | awk '{print $5}' | sed 's/%//')
    if [ $USAGE -gt 80 ]; then
        echo "âš  ç£ç›˜ä½¿ç”¨ç‡: ${USAGE}%"
    fi
}

check_service
check_disk
```

---

## å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

```bash
# ========== éƒ¨ç½²ç›¸å…³ ==========
bash deploy.sh                      # ä¸€é”®éƒ¨ç½²

# ========== æœåŠ¡ç®¡ç† ==========
docker-compose -f docker-compose.prod.yml up -d      # å¯åŠ¨
docker-compose -f docker-compose.prod.yml down       # åœæ­¢
docker-compose -f docker-compose.prod.yml restart    # é‡å¯
docker-compose -f docker-compose.prod.yml ps         # çŠ¶æ€

# ========== æ—¥å¿—æŸ¥çœ‹ ==========
docker-compose -f docker-compose.prod.yml logs -f    # æ‰€æœ‰æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs backend  # åç«¯æ—¥å¿—

# ========== å¤‡ä»½æ¢å¤ ==========
bash backup.sh                      # æ‰§è¡Œå¤‡ä»½
ls /root/backups/                   # æŸ¥çœ‹å¤‡ä»½

# ========== å¥åº·æ£€æŸ¥ ==========
curl http://106.14.204.36/api/health   # æ£€æŸ¥åç«¯
curl http://106.14.204.36              # æ£€æŸ¥å‰ç«¯
```

---

## è®¿é—®åœ°å€

éƒ¨ç½²å®Œæˆåï¼Œå¯é€šè¿‡ä»¥ä¸‹åœ°å€è®¿é—®ï¼š

- **å‰ç«¯åº”ç”¨**: http://106.14.204.36
- **API æ–‡æ¡£**: http://106.14.204.36/api/docs
- **å¥åº·æ£€æŸ¥**: http://106.14.204.36/api/health

---

## è”ç³»æ”¯æŒ

å¦‚é‡é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- ğŸ“„ [é¡¹ç›®è¯¦ç»†è¯´æ˜.md](./é¡¹ç›®è¯¦ç»†è¯´æ˜.md)
- ğŸ“‹ [README.md](./README.md)
- ğŸ› GitHub Issues

---

**éƒ¨ç½²æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æ›´æ–°æ—¶é—´**: 2024-10-23  
**é€‚ç”¨ç³»ç»Ÿ**: Ubuntu 20.04+ / CentOS 7+

