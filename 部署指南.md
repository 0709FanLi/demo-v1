# 🚀 抗衰老专家咨询系统 - 部署指南

## 📋 目录

1. [部署概述](#部署概述)
2. [服务器要求](#服务器要求)
3. [快速部署](#快速部署)
4. [手动部署](#手动部署)
5. [日常运维](#日常运维)
6. [故障排查](#故障排查)
7. [备份恢复](#备份恢复)

---

## 部署概述

### 架构说明

本项目采用 **Docker Compose** 部署方案，包含以下服务：

```
┌─────────────────────────────────────┐
│         Nginx (80)                  │
│    反向代理 + 负载均衡               │
└──────────┬──────────────────────────┘
           │
    ┌──────┴──────┐
    │             │
┌───▼────┐   ┌───▼────┐
│Frontend│   │Backend │
│ (3000) │   │ (8001) │
└────────┘   └───┬────┘
                 │
          ┌──────▼──────┐
          │   Milvus    │
          │  (19530)    │
          │   + etcd    │
          │   + minio   │
          └─────────────┘
```

### 服务信息

| 服务 | 端口 | 说明 |
|------|------|------|
| Nginx | 80 | Web 入口 |
| Frontend | 3000 | React 应用 |
| Backend | 8001 | FastAPI 应用 |
| Milvus | 19530 | 向量数据库 |

---

## 服务器要求

### 硬件配置

- **CPU**: 2 核心以上
- **内存**: 4GB 以上（推荐 8GB）
- **硬盘**: 20GB 以上可用空间
- **网络**: 公网 IP，开放 80、443、22 端口

### 软件要求

- **操作系统**: Ubuntu 20.04+ / CentOS 7+
- **Docker**: 20.10+
- **Docker Compose**: 2.0+

**本项目服务器**：
- IP: 106.14.204.36
- 用户: root
- 已开放端口: 22, 80, 443

---

## 快速部署

### 方式一：一键部署（推荐）⭐

在**本地**执行：

```bash
# 1. 进入项目目录
cd /Users/liguangyuan/Documents/GitHub/demo-v1

# 2. 执行部署脚本
bash deploy.sh
```

**脚本会自动完成**：
- ✅ 检查环境
- ✅ 连接服务器
- ✅ 同步代码
- ✅ 安装 Docker
- ✅ 构建镜像
- ✅ 启动服务
- ✅ 配置防火墙
- ✅ 健康检查

**预计时间**: 10-15 分钟

---

### 方式二：分步部署

#### 步骤1：同步代码到服务器

```bash
# 使用 rsync 同步
rsync -avz --delete \
  --exclude 'node_modules/' \
  --exclude 'venv/' \
  --exclude 'volumes/' \
  --exclude '.git/' \
  ./ root@106.14.204.36:/root/anti-aging-system/
```

#### 步骤2：SSH 连接服务器

```bash
ssh root@106.14.204.36
# 密码: Yuan0730zhen.
```

#### 步骤3：安装 Docker

```bash
# 安装 Docker
curl -fsSL https://get.docker.com | sh
systemctl start docker
systemctl enable docker

# 安装 Docker Compose
curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose

# 验证安装
docker --version
docker-compose --version
```

#### 步骤4：配置环境变量

```bash
cd /root/anti-aging-system

# 复制环境变量模板
cp env.production.template .env

# 编辑环境变量（如需修改）
vim .env
```

#### 步骤5：创建必要目录

```bash
mkdir -p logs/backend logs/nginx
mkdir -p volumes/etcd volumes/minio volumes/milvus
mkdir -p backend/data
```

#### 步骤6：启动服务

```bash
# 构建并启动所有服务
docker-compose -f docker-compose.prod.yml up -d --build

# 查看启动日志
docker-compose -f docker-compose.prod.yml logs -f
```

#### 步骤7：验证部署

```bash
# 检查服务状态
docker-compose -f docker-compose.prod.yml ps

# 检查健康状态
curl http://localhost/api/health
curl http://localhost
```

---

## 日常运维

### 查看服务状态

```bash
cd /root/anti-aging-system

# 查看所有容器状态
docker-compose -f docker-compose.prod.yml ps

# 查看资源使用
docker stats
```

### 查看日志

```bash
# 查看所有服务日志
docker-compose -f docker-compose.prod.yml logs -f

# 查看特定服务日志
docker-compose -f docker-compose.prod.yml logs -f backend
docker-compose -f docker-compose.prod.yml logs -f frontend
docker-compose -f docker-compose.prod.yml logs -f milvus-standalone

# 查看最近100行日志
docker-compose -f docker-compose.prod.yml logs --tail=100 backend
```

### 重启服务

```bash
# 重启所有服务
docker-compose -f docker-compose.prod.yml restart

# 重启特定服务
docker-compose -f docker-compose.prod.yml restart backend
docker-compose -f docker-compose.prod.yml restart frontend
```

### 停止服务

```bash
# 停止所有服务
docker-compose -f docker-compose.prod.yml down

# 停止并删除所有数据（危险！）
docker-compose -f docker-compose.prod.yml down -v
```

### 更新应用

```bash
# 方法1：本地执行部署脚本（推荐）
bash deploy.sh

# 方法2：服务器手动更新
cd /root/anti-aging-system
git pull  # 如果使用 git
docker-compose -f docker-compose.prod.yml up -d --build
```

### 清理 Docker 资源

```bash
# 清理未使用的镜像
docker image prune -a

# 清理未使用的容器
docker container prune

# 清理未使用的卷
docker volume prune

# 全面清理（谨慎使用）
docker system prune -a
```

---

## 故障排查

### 问题1：服务无法启动

**症状**：容器启动后立即退出

**排查步骤**：

```bash
# 1. 查看容器状态
docker-compose -f docker-compose.prod.yml ps

# 2. 查看错误日志
docker-compose -f docker-compose.prod.yml logs backend

# 3. 检查端口占用
netstat -tlnp | grep -E ':(80|3000|8001|19530)'

# 4. 检查磁盘空间
df -h

# 5. 检查内存
free -h
```

**常见原因**：
- 端口被占用
- 环境变量未配置
- 磁盘空间不足
- 内存不足

---

### 问题2：前端无法访问后端

**症状**：前端显示 Network Error

**排查步骤**：

```bash
# 1. 检查后端健康状态
curl http://localhost:8001/health

# 2. 检查 Nginx 配置
docker-compose -f docker-compose.prod.yml logs nginx

# 3. 检查网络连通性
docker-compose -f docker-compose.prod.yml exec frontend ping backend

# 4. 检查 CORS 配置
# 查看后端日志中的 CORS 相关信息
```

**解决方案**：
- 确认后端服务正常运行
- 检查 Nginx 反向代理配置
- 确认 API URL 配置正确

---

### 问题3：Milvus 连接失败

**症状**：后端日志显示 Milvus 连接错误

**排查步骤**：

```bash
# 1. 检查 Milvus 状态
docker-compose -f docker-compose.prod.yml ps milvus-standalone

# 2. 检查 Milvus 健康状态
curl http://localhost:9091/healthz

# 3. 查看 Milvus 日志
docker-compose -f docker-compose.prod.yml logs milvus-standalone

# 4. 检查 etcd 和 minio
docker-compose -f docker-compose.prod.yml ps etcd minio
```

**解决方案**：
- 等待 Milvus 完全启动（约30秒）
- 检查 volumes 目录权限
- 重启 Milvus 服务

---

### 问题4：内存不足

**症状**：服务频繁重启，系统卡顿

**排查步骤**：

```bash
# 查看内存使用
free -h

# 查看各容器内存使用
docker stats --no-stream
```

**解决方案**：

1. **优化 Docker 资源限制**：

编辑 `docker-compose.prod.yml`，添加资源限制：

```yaml
services:
  backend:
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
```

2. **增加 Swap 空间**：

```bash
# 创建 2GB Swap
dd if=/dev/zero of=/swapfile bs=1M count=2048
chmod 600 /swapfile
mkswap /swapfile
swapon /swapfile

# 永久生效
echo '/swapfile none swap sw 0 0' >> /etc/fstab
```

---

## 备份恢复

### 自动备份

服务器上已配置备份脚本：

```bash
# 执行备份
cd /root/anti-aging-system
bash backup.sh

# 备份位置
ls -lh /root/backups/
```

**备份内容**：
- Milvus 数据（volumes/milvus）
- etcd 数据（volumes/etcd）
- MinIO 数据（volumes/minio）
- 后端数据（backend/data）
- 环境配置（.env）

**自动化备份**（可选）：

```bash
# 添加定时任务（每天凌晨2点备份）
crontab -e

# 添加以下行
0 2 * * * cd /root/anti-aging-system && bash backup.sh >> /root/backups/backup.log 2>&1
```

---

### 恢复数据

```bash
# 1. 停止服务
docker-compose -f docker-compose.prod.yml down

# 2. 解压备份
cd /root/backups
tar -xzf anti-aging-backup-YYYYMMDD_HHMMSS.tar.gz

# 3. 恢复数据
cd anti-aging-backup-YYYYMMDD_HHMMSS
cp -r milvus /root/anti-aging-system/volumes/
cp -r etcd /root/anti-aging-system/volumes/
cp -r minio /root/anti-aging-system/volumes/
cp -r data /root/anti-aging-system/backend/

# 4. 重启服务
cd /root/anti-aging-system
docker-compose -f docker-compose.prod.yml up -d
```

---

## 安全建议

### 1. 更改默认密码

```bash
# 更改 root 密码
passwd root

# 更改服务器 SSH 密码后，更新本地 deploy.sh 中的密码
```

### 2. 配置防火墙

```bash
# 安装 ufw
apt-get install ufw

# 配置规则
ufw allow 22/tcp   # SSH
ufw allow 80/tcp   # HTTP
ufw allow 443/tcp  # HTTPS（如需）

# 启用防火墙
ufw enable

# 查看状态
ufw status
```

### 3. 配置 HTTPS（可选）

```bash
# 安装 Certbot
apt-get install certbot

# 如果有域名，申请证书
certbot certonly --standalone -d your-domain.com

# 更新 Nginx 配置支持 HTTPS
```

### 4. 限制 API 访问（可选）

可以在 Nginx 配置中添加 IP 白名单：

```nginx
# 仅允许特定 IP 访问 API
location /api/ {
    allow 1.2.3.4;  # 允许的 IP
    deny all;       # 拒绝其他
    proxy_pass http://backend_api/api/;
}
```

---

## 监控和告警

### 简单监控脚本

创建 `/root/monitor.sh`：

```bash
#!/bin/bash

# 检查服务状态
check_service() {
    if curl -s http://localhost/api/health | grep -q "OK"; then
        echo "✓ 服务正常"
    else
        echo "✗ 服务异常"
        # 可以发送告警邮件或钉钉通知
    fi
}

# 检查磁盘空间
check_disk() {
    USAGE=$(df -h / | tail -1 | awk '{print $5}' | sed 's/%//')
    if [ $USAGE -gt 80 ]; then
        echo "⚠ 磁盘使用率: ${USAGE}%"
    fi
}

check_service
check_disk
```

---

## 常用命令速查

```bash
# ========== 部署相关 ==========
bash deploy.sh                      # 一键部署

# ========== 服务管理 ==========
docker-compose -f docker-compose.prod.yml up -d      # 启动
docker-compose -f docker-compose.prod.yml down       # 停止
docker-compose -f docker-compose.prod.yml restart    # 重启
docker-compose -f docker-compose.prod.yml ps         # 状态

# ========== 日志查看 ==========
docker-compose -f docker-compose.prod.yml logs -f    # 所有日志
docker-compose -f docker-compose.prod.yml logs backend  # 后端日志

# ========== 备份恢复 ==========
bash backup.sh                      # 执行备份
ls /root/backups/                   # 查看备份

# ========== 健康检查 ==========
curl http://106.14.204.36/api/health   # 检查后端
curl http://106.14.204.36              # 检查前端
```

---

## 访问地址

部署完成后，可通过以下地址访问：

- **前端应用**: http://106.14.204.36
- **API 文档**: http://106.14.204.36/api/docs
- **健康检查**: http://106.14.204.36/api/health

---

## 联系支持

如遇问题，请查看：
- 📄 [项目详细说明.md](./项目详细说明.md)
- 📋 [README.md](./README.md)
- 🐛 GitHub Issues

---

**部署文档版本**: 1.0  
**更新时间**: 2024-10-23  
**适用系统**: Ubuntu 20.04+ / CentOS 7+

